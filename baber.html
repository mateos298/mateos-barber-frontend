<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mateo's Barber - Peluquería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #333333; /* Negro */
            --primary-dark: #000000; /* Negro más oscuro */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9fafb;
        }
        
        .calendar-day {
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background-color: var(--primary);
            color: white;
            cursor: pointer;
        }
        
        .selected-day {
            background-color: var(--primary-dark);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .service-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }
        
        .reserve-btn {
            background-color: var(--primary-dark);
            transition: all 0.3s ease;
        }
        
        .reserve-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .time-slot {
            transition: all 0.2s ease;
        }
        
        .time-slot:hover {
            background-color: var(--primary);
            color: white;
            cursor: pointer;
        }
        
        .selected-slot {
            background-color: var(--primary-dark);
            color: white;
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="Imagen de WhatsApp 2025-06-30 a las 14.21.49_38c080c3.jpg" alt="Logo Barber Mateo" class="h-12 object-contain">
                <h1 class="text-2xl font-bold text-gray-800">Mateo's Barber</h1>
            </div>
            <nav class="hidden md:flex flex-grow justify-center space-x-12">
                <a href="#" class="text-gray-800 font-medium hover:text-black">Inicio</a>
                <a href="#turnos" class="text-gray-600 hover:text-black">Reservar Turno</a>
                <a href="#contacto" class="text-gray-600 hover:text-black">Contacto</a>
            </nav>
            <button class="md:hidden text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>
    </header>

    <section class="relative bg-gradient-to-r from-gray-700 to-gray-900 text-white py-20">
        <div class="container mx-auto px-4 flex flex-col md:flex-row items-center">
            <div class="md:w-1/2 mb-10 md:mb-0">
                <h2 class="text-4xl md:text-5xl font-bold mb-6">Transforma tu estilo con nosotros</h2>
                <a href="#turnos" class="reserve-btn inline-block px-8 py-3 rounded-full font-bold text-white bg-black hover:bg-gray-800">Reservar Turno</a>
            </div>
            <div class="md:w-1/2">
                <img src="Imagen de WhatsApp 2025-06-30 a las 14.21.49_38c080c3.jpg" alt="Logo Barber Mateo" class="rounded-lg shadow-xl transform translate-y-0 transition-all duration-500 hover:translate-y-2 mx-auto max-h-64">
            </div>
        </div>
    </section>

    <section id="turnos" class="py-20 bg-gray-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12 text-gray-800">Reservar Turno</h2>
            
            <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
                <div class="md:flex">
                    <div class="md:w-1/2 p-8 border-r border-gray-200">
                        <h3 class="text-xl font-bold mb-6 text-gray-800">Seleccionar Fecha</h3>
                        <div class="mb-4 flex justify-between items-center">
                            <button id="prev-month" class="text-gray-600 hover:text-black">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <h4 id="current-month" class="text-lg font-medium text-gray-800">Junio 2023</h4>
                            <button id="next-month" class="text-gray-600 hover:text-black">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 mb-2">
                            <div class="text-center text-gray-500 font-medium">Dom</div>
                            <div class="text-center text-gray-500 font-medium">Lun</div>
                            <div class="text-center text-gray-500 font-medium">Mar</div>
                            <div class="text-center text-gray-500 font-medium">Mié</div>
                            <div class="text-center text-gray-500 font-medium">Jue</div>
                            <div class="text-center text-gray-500 font-medium">Vie</div>
                            <div class="text-center text-gray-500 font-medium">Sáb</div>
                        </div>
                        <div id="calendar-days" class="grid grid-cols-7 gap-2">
                            </div>
                    </div>
                    
                    <div class="md:w-1/2 p-8">
                        <h3 class="text-xl font-bold mb-6 text-gray-800">Seleccionar Hora</h3>
                        <div id="time-slots" class="mb-8 grid grid-cols-3 gap-2">
                            </div>
                        
                        <form id="booking-form">
                            <div class="mb-4">
                                <label for="service" class="block text-gray-700 font-medium mb-2">Servicio:</label>
                                <select id="service" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black">
                                    <option value="corte">Corte</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="name" class="block text-gray-700 font-medium mb-2">Nombre:</label>
                                <input type="text" id="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black" required>
                            </div>
                            <div class="mb-4">
                                <label for="phone" class="block text-gray-700 font-medium mb-2">Teléfono:</label>
                                <input type="tel" id="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black" required>
                            </div>
                            <div class="mb-4">
                                <label for="email" class="block text-gray-700 font-medium mb-2">Email (opcional):</label>
                                <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <button type="submit" class="reserve-btn w-full py-3 px-4 rounded-lg font-bold text-white">Confirmar Reserva</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="contacto" class="py-20 bg-gray-800 text-white">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                <div>
                    <h2 class="text-3xl font-bold mb-6">Contacto</h2>
                    <p class="mb-6">Visítanos en nuestro local o contáctanos para más información.</p>
                    <div class="mb-4 flex items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <div>
                            <h4 class="font-bold">Dirección</h4>
                            <p>Calle Oroño 1011, Sastre</p>
                        </div>
                    </div>
                    <div class="mb-4 flex items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                        <div>
                            <h4 class="font-bold">Teléfono</h4>
                            <p>3406 520275</p>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-2xl font-bold mb-6">Horario de Atención</h3>
                    <div class="bg-white text-gray-800 rounded-lg p-6">
                        <div class="flex justify-between mb-3 pb-3 border-b border-gray-200">
                            <span>Lunes - Viernes</span>
                            <span class="font-medium">9:00 - 19:00</span>
                        </div>
                        <div class="flex justify-between mb-3 pb-3 border-b border-gray-200">
                            <span>Sábado</span>
                            <span class="font-medium">10:00 - 16:00</span>
                        </div>
                        <div class="text-red-500 font-medium">
                            Domingo - Cerrado
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 text-white py-10">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center space-x-2 mb-4">
                        <div class="w-8 h-8 rounded-full bg-black flex items-center justify-center">
                        </div>
                        <h2 class="text-xl font-bold">Mateo's Barber</h2>
                    </div>
                    <p class="text-gray-400">Transformamos estilos </p>
                </div>
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.351c0 .731.593 1.324 1.325 1.324h11.495v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12v9.293h6.116c.73 0 1.323-.593 1.323-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z"/>
                        </svg>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                        </svg>
                    </a>
                </div>
            </div>
            <div class="mt-10 pt-6 border-t border-gray-700 text-center text-gray-400 text-sm">
                <p>© 2025 Mateo's Barber. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Reserva Confirmada</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="confirmation-details" class="mb-6">
                </div>
            <button id="modal-ok-btn" class="w-full py-3 px-4 bg-gray-800 hover:bg-black rounded-lg font-bold text-white">
                Entendido
            </button>
        </div>
    </div>
<script>
    // Calendar functionality
    let currentDate = new Date();

    // URL de tu API backend
    const backendURL = "https://mateos-barber-api.onrender.com" // Esta es la variable correcta

    // Función para obtener los turnos reservados del backend
    async function fetchReservedSlots() {
        try {
            // CAMBIO AQUÍ: Usamos backendURL y añadimos la ruta /api/turnos
            const response = await fetch(`${backendURL}/api/turnos`); 
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            // Asegúrate de que tu backend devuelve un array de strings con el formato "YYYY-MM-DD-HH:MM"
            // Por ejemplo: ["2025-07-01-09:00", "2025-07-01-09:30"]
            // Si tu backend devuelve un objeto con una propiedad 'reservedSlots', entonces usa data.reservedSlots
            return data.reservedSlots || []; 
        } catch (error) {
            console.error('Error fetching reserved slots:', error);
            // Si hay un error, devuelve un array vacío para no bloquear la UI
            return [];
        }
    }

    async function renderCalendar() {
        const calendarDays = document.getElementById('calendar-days');
        const monthYear = document.getElementById('current-month');

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        monthYear.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

        const prevLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();
        const firstDayIndex = firstDay.getDay(); // 0 = Domingo, 1 = Lunes...

        const nextDays = 7 - lastDay.getDay() - 1;

        calendarDays.innerHTML = '';

        // Días del mes anterior
        for (let i = firstDayIndex; i > 0; i--) {
            const day = prevLastDay - i + 1;
            const dayElement = document.createElement('div');
            dayElement.className = 'text-center text-gray-400';
            dayElement.textContent = day;
            calendarDays.appendChild(dayElement);
        }

        // Días del mes actual
        for (let i = 1; i <= lastDay.getDate(); i++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'text-center calendar-day p-2 rounded-full';
            dayElement.textContent = i;

            const today = new Date();
            // Evitar seleccionar días pasados o domingos si no es el actual
            const currentCalendarDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
            if (currentCalendarDay.getDay() === 0) { // Domingo
                dayElement.classList.add('opacity-50', 'cursor-not-allowed');
                dayElement.style.pointerEvents = 'none';
                dayElement.title = 'Domingo - Cerrado';
            } else if (currentCalendarDay < new Date(today.getFullYear(), today.getMonth(), today.getDate())) { // Día pasado
                 dayElement.classList.add('opacity-50', 'cursor-not-allowed');
                 dayElement.style.pointerEvents = 'none';
                 dayElement.title = 'Día pasado';
            } else if (i === today.getDate() && currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear()) {
                // Marcar el día actual visualmente
                dayElement.classList.add('bg-gray-100', 'text-gray-800');
            }

            dayElement.addEventListener('click', function() {
                // Solo permite seleccionar si no es un día deshabilitado
                if (!this.classList.contains('cursor-not-allowed')) {
                    document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected-day'));
                    this.classList.add('selected-day');
                    generateTimeSlots(); // Regenerar las horas disponibles para el día seleccionado
                }
            });

            calendarDays.appendChild(dayElement);
        }

        // Días del mes siguiente
        for (let i = 1; i <= nextDays; i++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'text-center text-gray-400';
            dayElement.textContent = i;
            calendarDays.appendChild(dayElement);
        }

        // Después de renderizar el calendario, si hay un día seleccionado, renderizar los slots
        // Esto es para cuando el usuario cambia de mes y vuelve a uno con un día ya seleccionado
        const currentSelectedDay = document.querySelector('.calendar-day.selected-day');
        if (currentSelectedDay) {
            generateTimeSlots();
        }
    }

    async function generateTimeSlots() {
        const timeSlotsContainer = document.getElementById('time-slots');
        timeSlotsContainer.innerHTML = '';

        const workHours = [9, 10, 11, 12, 13, 14, 15, 16, 17, 18]; // 9am to 6pm in 24h format

        const selectedDayElement = document.querySelector('.calendar-day.selected-day');
        if (!selectedDayElement) {
            // Si no hay día seleccionado, mostrar un mensaje o simplemente no generar slots
            timeSlotsContainer.innerHTML = '<p class="text-center text-gray-500 col-span-3">Selecciona una fecha para ver los horarios disponibles.</p>';
            return; 
        }
        
        // Evita generar slots si el día seleccionado está deshabilitado (domingo o pasado)
        if (selectedDayElement.classList.contains('cursor-not-allowed')) {
            timeSlotsContainer.innerHTML = '<p class="text-center text-red-500 col-span-3">No hay turnos disponibles para este día.</p>';
            return;
        }

        const selectedDayNumber = selectedDayElement.textContent.padStart(2, '0'); // Asegurarse de que tenga 2 dígitos
        const selectedMonth = currentDate.getMonth();
        const selectedYear = currentDate.getFullYear();

        // OBTENER LOS TURNOS RESERVADOS DEL BACKEND
        const reservedSlots = await fetchReservedSlots(); // Asegúrate de llamar a esto aquí

        workHours.forEach(hour => {
            ['00', '30'].forEach(minutes => {
                const dayOfWeek = new Date(selectedYear, selectedMonth, selectedDayNumber).getDay(); // 0 = Domingo, 6 = Sábado
                let lastReservableHour = 18; // Default for weekdays (hasta las 18:00)
                if (dayOfWeek === 6) { // Sábado
                    lastReservableHour = 15; // Hasta las 15:00
                } else if (dayOfWeek === 0) { // Domingo - no hay turnos
                    return; // No genera slots para el domingo
                }

                // Considerar la hora actual para el día de hoy
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();

                const slotDateTime = new Date(selectedYear, selectedMonth, parseInt(selectedDayNumber), hour, parseInt(minutes));
                
                // Si la fecha seleccionada es hoy y la hora del slot ya pasó
                if (slotDateTime < now && 
                    selectedYear === now.getFullYear() && 
                    selectedMonth === now.getMonth() && 
                    parseInt(selectedDayNumber) === now.getDate()) {
                    return; // No mostrar slots que ya pasaron hoy
                }

                if (hour > lastReservableHour || (hour === lastReservableHour && minutes === '30')) {
                    return; // No genera slots después de la hora límite
                }

                const timeSlotValue = `${hour.toString().padStart(2, '0')}:${minutes}`;

                // Clave única para el turno: "YYYY-MM-DD-HH:MM"
                const slotKey = `${selectedYear}-${(selectedMonth + 1).toString().padStart(2, '0')}-${selectedDayNumber}-${timeSlotValue}`;

                const timeSlotElement = document.createElement('div');
                timeSlotElement.className = 'time-slot text-center py-2 rounded-lg border border-gray-200';

                const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                timeSlotElement.textContent = `${displayHour}:${minutes} ${ampm}`;

                // Marcar turnos ocupados si están en la lista de reservedSlots del backend
                if (reservedSlots.includes(slotKey)) {
                    timeSlotElement.classList.add('selected-slot', 'opacity-50', 'cursor-not-allowed');
                    timeSlotElement.style.pointerEvents = 'none';
                    timeSlotElement.title = 'Turno ocupado';
                } else {
                    timeSlotElement.addEventListener('click', function() {
                        document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected-slot'));
                        this.classList.add('selected-slot');
                    });
                }

                timeSlotsContainer.appendChild(timeSlotElement);
            });
        });
    }

    // Event listeners for month navigation
    document.getElementById('prev-month').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    document.getElementById('next-month').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    // Form submission
    document.getElementById('booking-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const selectedDayElement = document.querySelector('.calendar-day.selected-day');
        const selectedTimeElement = document.querySelector('.time-slot.selected-slot');

        if (!selectedDayElement || !selectedTimeElement || selectedTimeElement.classList.contains('cursor-not-allowed')) {
            alert('Por favor selecciona una fecha y hora disponible.');
            return;
        }

        const selectedDayNumber = selectedDayElement.textContent;
        const selectedMonth = currentDate.getMonth();
        const selectedYear = currentDate.getFullYear();

        let [hourStr, minuteStr] = selectedTimeElement.textContent.split(' ')[0].split(':');
        let ampm = selectedTimeElement.textContent.split(' ')[1];
        let hour = parseInt(hourStr);
        if (ampm === 'PM' && hour < 12) hour += 12;
        if (ampm === 'AM' && hour === 12) hour = 0;
        const timeForStorage = `${hour.toString().padStart(2, '0')}:${minuteStr}`;

        // Get form values
        const service = document.getElementById('service').value;
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const email = document.getElementById('email').value;

        // ENVIAR LA RESERVA AL BACKEND
        try {
            // CAMBIO AQUÍ: Usamos backendURL y añadimos la ruta /api/turnos
            const response = await fetch(`${backendURL}/api/turnos`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fecha: `${selectedYear}-${(selectedMonth + 1).toString().padStart(2, '0')}-${selectedDayNumber.padStart(2, '0')}`,
                    hora: timeForStorage, // Hora en formato HH:MM (24h) para el backend
                    servicio: service,
                    nombre: name,
                    telefono: phone,
                    email: email
                })
            });

            const result = await response.json();

            if (!response.ok) {
                // Si el backend devuelve un error (ej. turno ya tomado)
                throw new Error(result.error || 'Algo salió mal al reservar el turno.');
            }

            // Si la reserva fue exitosa
            alert(result.message); 

            // Get service display name for confirmation modal
            const serviceSelect = document.getElementById('service');
            const serviceText = serviceSelect.options[serviceSelect.selectedIndex].text;

            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const month = monthNames[currentDate.getMonth()];
            const day = selectedDayElement.textContent;

            const confirmationDetails = document.getElementById('confirmation-details');
            confirmationDetails.innerHTML = `
                <div class="mb-4">
                    <p class="text-gray-600">Nombre: <span class="font-medium text-gray-800">${name}</span></p>
                    <p class="text-gray-600">Teléfono: <span class="font-medium text-gray-800">${phone}</span></p>
                    ${email ? `<p class="text-gray-600">Email: <span class="font-medium text-gray-800">${email}</span></p>` : ''}
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="font-bold text-gray-800 mb-1">Detalles de la reserva:</p>
                    <p class="text-gray-800">Servicio: ${serviceText}</p>
                    <p class="text-gray-800">Fecha: ${day} de ${month}</p>
                    <p class="text-gray-800">Hora: ${selectedTimeElement.textContent}</p>
                </div>
            `;

            document.getElementById('booking-modal').classList.remove('hidden');

            // Re-render time slots to visually update the newly reserved one
            generateTimeSlots(); // Esto volverá a llamar a fetchReservedSlots()
        } catch (error) {
            console.error('Error during booking:', error);
            alert(`Error al reservar: ${error.message}`);
        }
    });

    // Modal close events
    document.getElementById('close-modal').addEventListener('click', function() {
        document.getElementById('booking-modal').classList.add('hidden');
        document.getElementById('booking-form').reset();
        document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected-day'));
        document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected-slot'));
        generateTimeSlots();
    });

    document.getElementById('modal-ok-btn').addEventListener('click', function() {
        document.getElementById('booking-modal').classList.add('hidden');
        document.getElementById('booking-form').reset();
        document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected-day'));
        document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected-slot'));
        generateTimeSlots();
    });

    // MODIFICACIÓN AQUÍ: Bloque DOMContentLoaded mejorado
    document.addEventListener('DOMContentLoaded', async function() {
        currentDate = new Date(); // Asegúrate de que currentDate siempre empiece en el día actual al cargar
        await renderCalendar(); // Asegúrate de que el calendario se renderice completamente primero

        const today = new Date();
        const currentDayNumber = today.getDate();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();

        // Buscar el elemento del día actual de forma más robusta
        const dayElements = document.querySelectorAll('#calendar-days .calendar-day');
        dayElements.forEach(dayElement => {
            // Convertir el texto del día a número
            const dayText = parseInt(dayElement.textContent);
            // Revisa si es el día actual Y no es un día "gris" (del mes anterior/siguiente)
            // Y no es un domingo (que ya tiene cursor-not-allowed)
            if (dayText === currentDayNumber && 
                currentDate.getMonth() === currentMonth && // Asegurarse que es el mes actual
                currentDate.getFullYear() === currentYear && // Asegurarse que es el año actual
                !dayElement.classList.contains('text-gray-400') &&
                !dayElement.classList.contains('cursor-not-allowed')) {
                
                dayElement.classList.add('selected-day');
                // Llamar a generateTimeSlots para cargar los slots para el día inicial seleccionado
                generateTimeSlots(); 
            }
        });
        
        // Si por alguna razón no se seleccionó el día actual automáticamente (ej. día pasado),
        // o para asegurar que los datos de turnos se carguen.
        // fetchReservedSlots(); // Ya se llama dentro de generateTimeSlots si un día está seleccionado, o en renderCalendar.
    });
</script>
</body>
</html>